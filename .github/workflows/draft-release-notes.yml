name: Create Draft Release (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 1.2.3)'
        required: true
        type: string

permissions:
  contents: write  # Required to create tags/releases

jobs:
  create-draft-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate version and extract changelog
        id: changelog
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG="v$VERSION"

          echo "Validating version: $VERSION"
          FIRST_VERSION=$(grep -E '^[0-9]+\.[0-9]+\.[0-9]+ - [0-9]{4}-[0-9]{2}-[0-9]{2}' CHANGELOG.md | head -1 | awk '{print $1}')

          if [ "$FIRST_VERSION" != "$VERSION" ]; then
            echo "::error ::CHANGELOG.md's latest version $FIRST_VERSION does not match input version $VERSION"
            exit 1
          fi

          echo "Versions match. Extracting changelog..."
          awk -v ver="$VERSION" '
            $0 ~ "^" ver " - " {
              in_section=1
              next
            }
            in_section {
              if ($0 ~ /^[0-9]+\.[0-9]+\.[0-9]+ - [0-9]{4}-[0-9]{2}-[0-9]{2}$/) exit
              print
            }
          ' CHANGELOG.md > latest_changelog.txt

          echo "changelog_section<<EOF" >> $GITHUB_OUTPUT
          cat latest_changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Create Git tag if not exists
        run: |
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping creation."
          else
            echo "Creating tag $TAG"
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ env.TAG }}
          body: |
            **Release Notes:**
            ${{ steps.changelog.outputs.changelog_section }}
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # - name: Download Artifacts from JFrog
      #   id: download_artifacts
      #   run: |
      #     set -e
      #     VERSION=${GITHUB_REF##*/}  # v1.2.3
      #     VERSION=${VERSION#v}       # 1.2.3
      #     BASE_URL="https://<our-jfrog-domain>.jfrog.io/artifactory/<our-repo>/releases"
      #     
      #     curl_retry() {
      #       local url=$1
      #       local output=$2
      #       for i in {1..3}; do
      #         echo "Attempt $i to download $url"
      #         if curl -u "${{ secrets.JFROG_USERNAME }}:${{ secrets.JFROG_PASSWORD }}" -fL "$url" -o "$output"; then
      #           echo "Downloaded $output"
      #           return 0
      #         fi
      #         echo "Retrying in 5s..."
      #         sleep 5
      #       done
      #       echo "::error ::Failed to download $url after 3 attempts"
      #       return 1
      #     }
      #     
      #     echo "Downloading .nupkg..."
      #     curl_retry "$BASE_URL/${VERSION}.nupkg" "${VERSION}.nupkg"
      #     
      #     mkdir -p assemblies
      #     declare -a components=("NationalInstruments.SemiconductorTestLibrary.Abstractions" "NationalInstruments.SemiconductorTestLibrary.Extensions" "NationalInstruments.SemiconductorTestLibrary.TestStandSteps")
      #     declare -a extensions=("dll" "pdb" "xml")
      #     
      #     for component in "${components[@]}"; do
      #       for ext in "${extensions[@]}"; do
      #         FILENAME="${component}.${ext}"
      #         URL="$BASE_URL/$FILENAME"
      #         OUTFILE="assemblies/$FILENAME"
      #         if ! curl_retry "$URL" "$OUTFILE"; then
      #           echo "::warning ::$FILENAME not found or failed to download."
      #         fi
      #       done
      #     done
      #     
      #     echo "Creating assemblies.zip..."
      #     cd assemblies
      #     if [ "$(ls -1 | wc -l)" -eq 0 ]; then
      #       echo "::error ::No files in assemblies/. Aborting zip creation."
      #       exit 1
      #     fi
      #     zip ../assemblies.zip *
      #     cd ..

      # - name: Upload Release Assets
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     tag_name: ${{ github.ref }}
      #     files: |
      #       *.nupkg
      #       assemblies.zip
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
